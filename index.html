<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>å¤šç„¦ç‚¹ãƒ¬ãƒ³ã‚ºè¨ºæ–­</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.7.0/nouislider.min.css" rel="stylesheet" />
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f5f5f5;padding:20px;max-width:600px;margin:auto}
    h1{text-align:center;margin-bottom:0.3em}
    p{text-align:center;color:#555;font-size:0.95em}
    #multi-slider.noUi-target{height:28px;margin:50px 0;background:#ddd;border-radius:22px;box-shadow:inset 0 4px 9px rgba(0,0,0,.28),inset 0 -3px 4px rgba(0,0,0,.12)}
    .noUi-handle{height:36px;width:36px;border-radius:50%;top:-6px;background:#fff;border:2px solid rgba(0,0,0,.35);box-shadow:0 4px 7px rgba(0,0,0,.48);transition:transform .1s}
    .noUi-handle:hover{transform:scale(1.12)}
    .noUi-tooltip{display:none!important}
    .noUi-connect{background:transparent}
    #multi-slider .noUi-connect:nth-child(1){background:#4caf50}
    #multi-slider .noUi-connect:nth-child(2){background:#2196f3}
    #multi-slider .noUi-connect:nth-child(3){background:#ffc107}
    #multi-slider .noUi-connect:nth-child(4){background:#e91e63}
    #labels{position:relative;height:0}
    .segment-label{position:absolute;pointer-events:none;white-space:nowrap;transform:translate(-50%,-50%);text-shadow:0 1px 1px rgba(255,255,255,.9)}
    .name-label{font-size:1.4em;color:#000;font-weight:700}
    .pct-label{font-size:1em;color:#000}
    #confirm-btn{display:block;margin:260px auto 0;padding:14px 34px;font-size:1.15em;background:#1976d2;color:#fff;border:none;border-radius:10px;cursor:pointer;box-shadow:0 3px 5px rgba(0,0,0,.35);transition:background .2s}
    #confirm-btn:hover{background:#1565c0}
    #results{margin-top:60px;font-size:1.08em}
    .result-item{margin:18px 0;opacity:0;transition:opacity .5s}
    .result-item.rank-1{font-size:1.5em;font-weight:800}
  </style>
</head>
<body>
  <h1>ğŸ‘ å¤šç„¦ç‚¹ãƒ¬ãƒ³ã‚ºè¨ºæ–­</h1>
  <p>ï¼“æœ¬ã®ãƒãƒ³ãƒ‰ãƒ«ã§ <strong>é®®æ˜ã• âœ é‹è»¢ âœ ãƒ‘ã‚½ã‚³ãƒ³ âœ èª­æ›¸</strong> ã®ãƒãƒ©ãƒ³ã‚¹ã‚’æ±ºã‚<br>ä¸‹ã® <strong>æ±ºå®š</strong> ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>

  <div id="multi-slider"></div>
  <div id="labels"></div>
  <button id="confirm-btn">æ±ºå®š</button>
  <div id="results"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.7.0/nouislider.min.js"></script>
  <script>
    /* æ­£è¦åŒ–ã‚¹ã‚³ã‚¢: [contrast, driving, computer, reading]  */
    const lensData=[
      {name:"Gemetric",           score:[22.73,16.21,22.11,21.76]},
      {name:"PanOptix",           score:[22.22,17.00,25.00,21.26]},
      {name:"AcrivaTrinova Pro",  score:[23.48,15.00,21.84,22.50]},
      {name:"Odyssey",            score:[24.00,19.50,21.05,20.00]}, /* contrast/driving æ‰‹å‹•è£œæ­£ */
      {name:"Vivity",             score:[23.00,18.00,21.98,15.63]}, /* contrast/driving â†“ */
      {name:"PureSee",            score:[24.75,23.00,19.21,15.53]},
      {name:"Symfony",            score:[23.23,10.00,19.74,15.26]},
      {name:"Lentis Comfort",     score:[23.99,19.00,13.16,10.00]},
      {name:"Monofocal",          score:[25.00,25.00,7.89, 5.26]},
      {name:"FineVision HP",      score:[21.72,13.00,22.37,25.00]}  /* å¾©æ´» */
    ];

    const slider=document.getElementById('multi-slider');
    const labelsEl=document.getElementById('labels');
    const resultsEl=document.getElementById('results');
    const btn=document.getElementById('confirm-btn');
    const names=["é®®æ˜ã•","é‹è»¢","ãƒ‘ã‚½ã‚³ãƒ³","èª­æ›¸"];

    noUiSlider.create(slider,{start:[25,50,75],connect:[true,true,true,true],range:{min:0,max:100},step:1,behaviour:'drag',tooltips:[true,true,true]});

    function renderAllLabels(vals){
      labelsEl.innerHTML='';
      const [a,b,c]=vals.map(Number);
      const seg=[a,b-a,c-b,100-c];
      let acc=0;
      seg.forEach((pct,i)=>{
        const center=acc+pct/2;
        const name=document.createElement('span');
        name.className='segment-label name-label';
        name.style.left=center+'%';
        name.style.top=(slider.getBoundingClientRect().height/2+6)+'px';
        name.textContent=names[i];
        labelsEl.appendChild(name);
        const lbl=document.createElement('span');
        lbl.className='segment-label pct-label';
        lbl.style.left=center+'%';
        lbl.style.top=(slider.getBoundingClientRect().height/2+32)+'px';
        lbl.textContent=pct.toFixed(1)+'%';
        labelsEl.appendChild(lbl);
        acc+=pct;
      });
    }

    slider.noUiSlider.on('update',v=>{
      renderAllLabels(v);
      slider.querySelectorAll('.noUi-tooltip').forEach(t=>t.style.display='none');
    });

    /* ã‚«ã‚¹ã‚¿ãƒ é †ä½ãƒ­ã‚¸ãƒƒã‚¯ */
    function customRank(weights){
      const [wC,wD,wPC,wR]=weights; // å„ã‚¦ã‚§ã‚¤ãƒˆ 0-1
      const sumFar = wC + wD;
      const sumNear = wPC + wR;
      // æ¡ä»¶â‘  èª­æ›¸>ãƒ‘ã‚½ã‚³ãƒ³ & è¿‘ç”¨åˆè¨ˆ>é ç”¨åˆè¨ˆ â†’ FineVision HP ã‚’1ä½ã«
      if(wR>wPC && sumNear>sumFar){
        return ['FineVision HP'];
      }
      // æ¡ä»¶â‘¡ ã»ã¼ãƒãƒ©ãƒ³ã‚¹ (å„ã‚¦ã‚§ã‚¤ãƒˆãŒ0.23ã€œ0.27ã®ç¯„å›²) â†’ å›ºå®šé †
      const balanced = weights.every(w=>Math.abs(w-0.25)<=0.02);
      if(balanced){
        return ['PanOptix','AcrivaTrinova Pro','Odyssey'];
      }
      return null; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ã‚³ã‚¢è¨ˆç®—ã¸
    }

    function diagnose(){
      resultsEl.innerHTML='';
      const [a,b,c]=slider.noUiSlider.get().map(Number);
      if(!(a<=b&&b<=c))return;
      const weights=[a,b-a,c-b,100-c].map(v=>v/100);

      // 1. äº‹å‰ãƒ«ãƒ¼ãƒ«ã«è©²å½“ã™ã‚‹ã‹?
      const ruleRank = customRank(weights);
      let ranked;
      if(ruleRank){
        // æŒ‡å®šãƒ¬ãƒ³ã‚ºã‚’å…ˆé ­ã«ã—æ®‹ã‚Šã¯é€šå¸¸ã‚¹ã‚³ã‚¢ã§ç¶šã‘ã‚‹
        const rest = lensData.filter(l=>!ruleRank.includes(l.name));
        const scoredRest=rest.map(l=>({name:l.name,total:l.score.reduce((s,v,i)=>s+v*weights[i],0)}))
                              .sort((p,q)=>q.total-p.total);
        ranked=[...ruleRank.map(n=>({name:n,total:99})),...scoredRest].slice(0,3);
      }else{
        // 2. é€šå¸¸ã‚¹ã‚³ã‚¢é †ä½
        ranked=lensData.map(l=>({name:l.name,total:l.score.reduce((s,v,i)=>s+v*weights[i],0)}))
                       .sort((p,q)=>q.total-p.total).slice(0,3);
      }

      ranked.forEach((l,i)=>{
        setTimeout(()=>{
          const row=document.createElement('div');
          row.className='result-item rank-'+(i+1);
          row.style.opacity='1';
          row.textContent=`${i+1}ä½: ${l.name}`;
          resultsEl.appendChild(row);
        },i*700);
      });
    }

    btn.addEventListener('click',diagnose);
    renderAllLabels([25,50,75]);
  </script>
</body>
</html>
